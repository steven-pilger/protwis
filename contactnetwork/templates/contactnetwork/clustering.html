{% extends "home/base.html" %}
{% load staticfiles %}

{% block content %}

      <div class="tab-content clearfix">
            <!-- BEGIN SINGLE CRYSTAL GROUP TAB -->
            <div class="tab-pane active" id="single-crystal-group-tab">
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Structures</h3>
                            </div>
                            <div class="panel-body">
                                <input class="crystal-pdb" type="hidden" value="[]" />
                                <h5><span class="crystal-count">0</span> structure(s) selected.</h5>
                                {# <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-group-pdbs-modal">Select Structures</button> #}
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#single-crystal-group-pdbs-modal-table">Select Structures</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="btn btn-success pull-left go-button">Go (distance pairs)</div>
                        <div class="btn btn-success pull-left go-button">Go (distance to core)</div>
                    </div>
                    <div class="col-md-2 hidden" id="output-group0">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Group 1</h3>
                            </div>
                            <div class="panel-body">
                                <textarea name="input-targets-0" id="input-targets-0" style="width: 100%;" wrap="off" rows="5" readonly></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 hidden" id="output-group1">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Group 2</h3>
                            </div>
                            <div class="panel-body">
                                <textarea name="input-targets-1" id="input-targets-1" style="width: 100%;" wrap="off" rows="5" readonly></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 hidden" id="submit-group">
                        <div class="btn btn-success pull-left CN-button disabled" id="CN-button">Contact Network</div>
                        <div class="btn btn-success pull-left DN-button disabled" id="DN-button">Distance Network</div>
                    </div>
                </div>

                <div class="row">
                  <div class="tab-content">
                      <div class="col-md-12 tab-pane active" id="single-group-tree-tab">
                           <div class="panel panel-default no-top-border">
                              <div class="panel-heading">
                                  <h3 class="panel-title pull-left">Conformational clusters (tree of structures)</h3>
                                  <span class="pull-right glyphicon glyphicon-fullscreen btn-fullscreen" data-toggle="tooltip" data-placement="bottom" title="Fullscreen"></span>
                                  <span class="pull-right glyphicon glyphicon-download btn-download" data-toggle="tooltip" data-placement="bottom" title="Download raw distance data (CSV)"></span>
                                  <span class="pull-right glyphicon glyphicon-tree-conifer btn-newick" data-toggle="tooltip" data-placement="bottom" title="Download tree (Newick format)"></span>
                                  <span class="pull-right glyphicon glyphicon-download-alt btn-download-alt" data-toggle="tooltip" data-placement="bottom" title="Download figure (SVG)"></span> <!-- Use this one for figure downloads? -->
                                  <span class="pull-right glyphicon glyphicon-picture btn-camera" data-toggle="tooltip" data-placement="bottom" title="Download figure (PNG)"></span> <!-- Use this one for PNG figure downloads? -->
                                  <div class="clearfix"></div>
                              </div>
                              <div class="panel-body">
                                  <div class="tree-container" id="tree-container">
                                      <div>
                                        <svg id="clustering-tree"></svg>
                                        <div class="legend_box">
                                          <div class="outer_legend"></div>
                                          <div class="inner_legend"></div>
                                        </div>
                                      </div>
                                  </div>
                              </div>
                           </div>
                      </div>
                    </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="tree-menu dropup">
                      <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                          Options <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#">
                              <label>Radial layout</label>
                              <input type="checkbox" id="radial-layout" checked/>
                            </a></li>
                            <li><a href="#">
                              <label>Color edges and leaves</label>
                              <input type="checkbox" id="colored-edges" checked/>
                            </a></li>
                            <li><a href="#">
                              <label>Hide PDB-codes</label>
                              <input type="checkbox" id="hide-pdbs"/>
                            </a></li>
                            <li><a href="#">
                                <label>Switch label order</label>
                                <input type="checkbox" id="label-order"/>
                            </a></li>
                        </ul>
                      </div>
                      <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                          Receptor names <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu names" role="menu">
                          <li class="active"><a href="#">UniProt names</a></li>
                          <li><a href="#">IUPHAR names</a></li>
                        </ul>
                      </div>
                      <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                          Outer markers<span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dataouter" role="menu">
                          <li><a href="#">No data</a></li>
                          <h6 class="dropdown-header">Classification</h6>
                          <li><a href="#">GPCR class</a></li>
                          <li><a href="#">Ligand type</a></li>
                          <li><a href="#">Receptor family</a></li>
                          <h6 class="dropdown-header">Structure</h6>
                          <li><a href="#">Receptor activation state</a></li>
                          <li class="active"><a href="#">Ligand function</a></li>
                          <li><a href="#">Experimental method</a></li>
                          <h6 class="dropdown-header">Coupling</h6>
                          <li><a href="#">All G-protein coupling</a></li>
                          <li><a href="#">Primary G-protein coupling</a></li>
                          <li><a href="#">Secondary G-protein coupling</a></li>
                        </ul>
                      </div>
                      <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                          Inner markers<span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu datainner" role="menu">
                          <li><a href="#">No data</a></li>
                          <h6 class="dropdown-header">Classification</h6>
                          <li><a href="#">GPCR class</a></li>
                          <li><a href="#">Ligand type</a></li>
                          <li><a href="#">Receptor family</a></li>
                          <h6 class="dropdown-header">Structure</h6>
                          <li class="active"><a href="#">Receptor activation state</a></li>
                          <li><a href="#">Ligand function</a></li>
                          <li><a href="#">Experimental method</a></li>
                          <h6 class="dropdown-header">Coupling</h6>
                          <li><a href="#">All G-protein coupling</a></li>
                          <li><a href="#">Primary G-protein coupling</a></li>
                          <li><a href="#">Secondary G-protein coupling</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            <!-- END SINGLE CRYSTAL GROUP TAB -->
        </div>

    <!-- BEGIN SINGLE CRYSTAL GROUP PDBS CHOOSER MODAL -->
    <div class="modal fade" id="single-crystal-group-pdbs-modal-table" role="dialog">
        <div class="modal-dialog modal-wide">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select a group of structures</h4>
                </div>
                <div class="modal-body">
                      <div class="col-md-12">
                        <span id="single-crystal-group-pdbs-modal-text">0 structure(s) selected</span>
                        <button type="button" onclick="resetselection();" class="btn btn-xs btn-primary reset-selection">Reset selection</button>
                        <div class="tableview"></div>
                      </div>
               </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END SINGLE CRYSTAL GROUP PDBS CHOOSER MODAL -->
    <div class="alert alert_pdb alert-warning fade out" id="bsalert">
      Please select at least two structures to compare
    </div>
{% endblock %}
{% block addon_js %}
    <script type="text/javascript" src="{% static 'home/js/snap.svg-min.js' %}"> </script>
    <script type="text/javascript" src="{% static 'home/js/typeahead.bundle.min.js' %}"> </script>

    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/selection.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
    <script src="{% static 'home/js/select2.js' %}"> </script>
    <script src="{% static 'home/js/jquery.tablesorter.js' %}"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="{% static 'home/js/newick.js' %}"> </script>

    <!-- PDB table -->
    <script type="text/javascript" src="{% static 'home/js/fixed_columns.js' %}"> </script>

    <!-- D3 -->
    <script type="text/javascript" src="{% static 'home/js/d3.v3.min.js' %}"> </script>
    <script src="{% static 'home/js/d3-color.v1.min.js' %}"></script>
    <script src="{% static 'home/js/d3-interpolate.v1.min.js' %}"></script>
    <script src="{% static 'home/js/d3-scale-chromatic.v1.min.js' %}"></script>
    <script src="{% static 'home/js/d3-selection-multi.v1.min.js' %}"></script>
    <script src="{% static 'home/js/phylo_library.js' %}"> </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>
    <script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>

    <script>
        window.zoomCluster = {};

        var phylotree;
        var treedata;
        var doBranchColoring = true;
        var hidePDBs = false;
        var labelReorder = false;
        var treeAnnotations = [];
        var couplingAnnotations = [];
        var typeClasses = ["Receptor activation state", "", "", "Receptor family", "Ligand type", "GPCR class", "Experimental method", "Ligand function", "G-protein coupling", "Primary G-protein coupling", "Secondary G-protein coupling"]
        var dataClasses, colorClasses;
        function renderTree(data) {
            dataClasses = [["active", "inactive", "intermediate"],0,0];
            colorClasses = [["#0F0", "#F00", "#F80"], 0, 0];
            treedata = data // store globally
            var tree = data["tree"]; // contains tree in Newick format

            // data annotations
            treeAnnotations = data["annotations"];

            // Annotations: 0 state, 1 name, 2 fullname, 3 family, 4 ligand type, 5 class, 6 method, 7 ligand function, 8 g-protein coupling
            for (var i = 3; i < 7; i++){
                dataClasses[i] = new Set()
                for (key in treeAnnotations)
                  dataClasses[i].add(treeAnnotations[key][i])
                dataClasses[i] = Array.from(dataClasses[i]).sort();
            }
            dataClasses[7] = ["agonist", "agonist-partial", "partial-agonist", "pam", "antagonist", "inverse-agonist", "nam"]
            dataClasses[8] = ['Gi/Go family', 'Gq/G11 family', 'Gs family', 'G12/G13 family']
            dataClasses[9] = dataClasses[8]
            dataClasses[10] = dataClasses[8]

            for (var i = colorClasses.length; i <= 8; i++) {
                colorClasses[i] = []
                if (i != 7) {
                  var class_colors;
                  if (dataClasses[i].length > 10) {
                    class_colors = d3.scale.category20()
                        .domain(dataClasses[i])
                  } else {
                    class_colors = d3.scale.category10()
                        .domain(dataClasses[i])
                  }
                  for (var j = 0; j < dataClasses[i].length; j++) {
                    colorClasses[i].push(class_colors(dataClasses[i][j]))
                  }
                }
            }
            colorClasses[7] = ["#0F0", "#0F0", "#0F0", "#0F0", "#F00", "#F00", "#F00"]
            colorClasses[9] = colorClasses[8]
            colorClasses[10] = colorClasses[8]

            // G-protein coupling
            couplingAnnotations = data["Gprot_coupling"];

            // Annotate and order coupling data
            for (name in treeAnnotations){
              var slug = treeAnnotations[name][8]
              treeAnnotations[name][8] = []
              treeAnnotations[name][9] = []
              treeAnnotations[name][10] = []
              var gproteins = dataClasses[8]
              for (g = 0; g < gproteins.length; g++) {
                if (slug in couplingAnnotations){
                  if ("primary" in couplingAnnotations[slug] && couplingAnnotations[slug]["primary"].includes(gproteins[g])) {
                    treeAnnotations[name][8].push(gproteins[g])
                    treeAnnotations[name][9].push(gproteins[g])
                  } else if ("secondary" in couplingAnnotations[slug] && couplingAnnotations[slug]["secondary"].includes(gproteins[g])){
                    treeAnnotations[name][8].push(gproteins[g])
                    treeAnnotations[name][10].push(gproteins[g])
                  }
                }
              }
            }

            /*var r = 1200 / 2;
            var spacing = 240;
            var innerRadius = r - spacing // change inner radius of tree with this argument
            var names = 0; // indexing for all nodes*/

            phylotree = d3.layout.phylotree()
            .svg(d3.select("#clustering-tree"))
            .options({
              'left-right-spacing': 'fit-to-size', // fit to given size left-to-right
              'top-bottom-spacing': 'fit-to-size', // fit to given size top-to-bottom
              //'left-right-spacing': 'fixed-step',
              //'top-bottom-spacing': 'fixed-step',
              //'left-offset': 200,
              'restricted-selectable': 'none', // disable normal selection
              'selectable': false,  // make nodes and branches not selectable
              'collapsible': false, // turn off the menu on internal nodes
              'transitions': false, // d3 animations
              'show-scale': false, // show/hide the scale
              'align-tips': true, // align node tips
              'brush': false, // brush
              'reroot': true, // rerooting
              'hide': false, // hiding a subtree
              'zoom': false, // zooming
              'inner_spacing': (newCluster ? 1 : 5) // extra spacing between splits in tree (own custom option)
            })
            .radial(true)
            .node_span ('equal')
            .size([document.getElementById('tree-container').offsetWidth*0.75, document.getElementById('tree-container').offsetWidth*0.9])
            .separation (function (a,b) {return 0.1;});


            // DRAW
            phylotree(tree)
              .style_nodes(nodeStyler)
              .style_edges(branchStyler)
              .layout(false);

            // REDRAW with the correct leaves
            maximumLeafSize()
            phylotree.layout(true)

            // set consensus values for each node
            phylotree.get_nodes().forEach(function(node){
              pdbs = connectedPDBs(node);

              // loop over dataclasses and assign conserved if present
              node['colorClasses'] = JSON.parse(JSON.stringify(treeAnnotations[pdbs[0]]));
              for (i = 1; i < pdbs.length; i++) {
                var pdb = pdbs[i]
                for (j = 0; j < node['colorClasses'].length; j++) {
                  if (Array.isArray(node['colorClasses'][j])) {
                      node['colorClasses'][j] = node['colorClasses'][j].filter(x => treeAnnotations[pdbs[i]][j].includes(x));
                  } else {
                      if (node['colorClasses'][j] != treeAnnotations[pdbs[i]][j]) {
                        node['colorClasses'][j] = "-"
                      }
                  }
                }
              }
            });

            if (doBranchColoring){
              // Refresh twice to ensure correct leaf coloring
              d3.layout.phylotree.trigger_refresh(phylotree);
              d3.layout.phylotree.trigger_refresh(phylotree);
            }

            // add legends
            refreshOuterLegend()
            refreshInnerLegend()

            // add custom menu items
            phylotree.get_nodes()
//              .filter(d3.layout.phylotree.is_leafnode)
              .forEach(function(tree_node) {
                d3.layout.phylotree.add_custom_menu(tree_node, // add to this node
                  menuGroup1, // display this text for the menu
                  function() { addGroup(0, tree_node); }, // on-click callback include a reference to tree_node via transitive closure
                  notInGroup1 // condition on when to display the menu
                  );
                d3.layout.phylotree.add_custom_menu(tree_node, // add to this node
                  menuGroup2, // display this text for the menu
                  function() { addGroup(1, tree_node); }, // on-click callback include a reference to tree_node via transitive closure
                  notInGroup2 // condition on when to display the menu
                  );
                d3.layout.phylotree.add_custom_menu(tree_node, // add to this node
                  menuRemoveGroup1, // display this text for the menu
                  function() { removeGroup(0, tree_node); }, // on-click callback include a reference to tree_node via transitive closure
                  inGroup1 // condition on when to display the menu
                  );
                d3.layout.phylotree.add_custom_menu(tree_node, // add to this node
                  menuRemoveGroup2, // display this text for the menu
                  function() { removeGroup(1, tree_node); }, // on-click callback include a reference to tree_node via transitive closure
                  inGroup2 // condition on when to display the menu
                  );
            });
        }

        var maxLeafNodeLenght = -1
        function maximumLeafSize(refresh = true) {
          // set to 0
          maxLeafNodeLenght = 0;

          // Find longest label
          d3.select("#clustering-tree").selectAll("text")[0].forEach(
            function(node_label){
              labelSize = node_label.getBBox().width*1.05
              if (labelSize > maxLeafNodeLenght){
                maxLeafNodeLenght = labelSize
              }
            });

          // redraw labels with new max
          if (refresh){
            d3.layout.phylotree.trigger_refresh(phylotree);
          }
        }

        function menuGroup1(node) {
            return "Add to group 1";
        }

        function menuGroup2(node) {
          return "Add to group 2";
        }

        function menuRemoveGroup1(node) {
            return "Remove from group 1";
        }

        function menuRemoveGroup2(node) {
          return "Remove from group 2";
        }

        var group1 = []
        var group2 = []
        function addGroup(selector, node) {
          // Go through nodes and update selection
          function sel(d) {
              if (d3.layout.phylotree.is_leafnode(d)) {
                if (selector > 0)
                  group2.push(d.name)
                else
                  group1.push(d.name)
              }

              d['group' + selector ] = true
              if (d.children && d.children.length > 0){
                d.children.forEach(sel);
              }
          }
          sel(node);

          // unique PDB codes
          group1 = Array.from(new Set(group1))
          group2 = Array.from(new Set(group2))
          group1.sort()
          group2.sort()

          // Toggle buttons
          if (group1.length > 0 || group2.length > 0){
            $("#CN-button").removeClass("disabled");
            $("#DN-button").removeClass("disabled");
          }

          // update selection with PDB codes
          var textarea = document.getElementById('input-targets-'+selector);
          if (selector > 0)
            textarea.value = group2.join("\n");
          else
            textarea.value = group1.join("\n");

          // refresh layout with updated selections
          d3.layout.phylotree.trigger_refresh(phylotree);
        }

        var displayName = 0
        function toggleNames(event){
          switch(event.target.innerText){
              case "UniProt names":
                displayName = 0
                break;
              case "IUPHAR names":
                displayName = 1
                break;
              default:
                displayName = 0
          }

          // update active label on menu items
          event.target.parentNode.parentElement.querySelectorAll( ".active" ).forEach( e =>
            e.classList.remove( "active" ) );
          event.target.parentNode.classList.add("active")

          // refresh layout with updated selections
          d3.layout.phylotree.trigger_refresh(phylotree);
          maximumLeafSize();
        }

        var displayData = 7
        function toggleDataOuter(event){
          var dataName = event.target.innerText

          displayData = menuItem(dataName)

          // Refresh legend
          refreshOuterLegend()

          // update active label on menu items
          event.target.parentNode.parentElement.querySelectorAll( ".active" ).forEach( e =>
            e.classList.remove( "active" ) );
          event.target.parentNode.classList.add("active")

          // Refresh layout with updated selections
          d3.layout.phylotree.trigger_refresh(phylotree);
          // Refresh twice to ensure correct leaf coloring
          if (doBranchColoring)
            d3.layout.phylotree.trigger_refresh(phylotree);
        }

        function refreshOuterLegend(){
          refreshLegend(".outer_legend", displayData)
        }

        function refreshInnerLegend(){
          refreshLegend(".inner_legend", displayDataInner)
        }

        function refreshLegend(div_class, selectData){
          d3.select(div_class).html("");
          if (selectData >= 0) {
            var svg_legend_receptor_class = d3.select(div_class).append("svg")
                .attr("height", (dataClasses[selectData].length+1)*20+"px")
                .attr("id", "class_legend_box");

            // add specific title to legend
            svg_legend_receptor_class.append("text")
                .attr("x", 0)
                .attr("y", 7)
                .attr("dy", ".35em")
                .text(typeClasses[selectData])
                .attr("fill", "black")
                .style("font-size", 14)
                .style("font-weight", "bold");

            //// Vertical Legend ////
            var class_legend = svg_legend_receptor_class.selectAll('.class_legend')
                .data(dataClasses[selectData])
                .enter().append('g')
                .attr("class", "class_legend_group")
                .attr("transform", function (d, i) {
                    return "translate(0," + i * 20 + ")"
                });

            if (div_class==".inner_legend"){
              class_legend.append("circle")
              .attr("cx", 7)
              .attr("cy", 25)
              .attr("r", 5)
              .style("stroke", "#000")
              .style("stroke-width", "1px")
              .style("fill", function (d) {
                  return colorClasses[selectData][dataClasses[selectData].indexOf(d)]
              });
            } else {
              class_legend.append("rect")
              .attr("x", 2)
              .attr("y", 20)
              .attr("width", 10)
              .attr("height", 10)
              .style("stroke", "#000")
              .style("stroke-width", "1px")
              .style("fill", function (d) {
                  return colorClasses[selectData][dataClasses[selectData].indexOf(d)]
              });
            }

            class_legend.append('text')
                .attr("x", 20)
                .attr("y", 30)
                .text(function (d) {
                    return (d)
                })
                .style("text-anchor", "start")
                .style("font-size", 13);
          }
        }

        var displayDataInner = 0
        function toggleDataInner(event){
          var dataName = event.target.innerText
          displayDataInner = menuItem(dataName)

          // Refresh legend
          refreshInnerLegend()

          // update active label on menu items
          event.target.parentNode.parentElement.querySelectorAll( ".active" ).forEach( e =>
            e.classList.remove( "active" ) );
          event.target.parentNode.classList.add("active")

          // Refresh layout with updated selections
          d3.layout.phylotree.trigger_refresh(phylotree);
          // Refresh twice to ensure correct leaf coloring
          if (doBranchColoring)
            d3.layout.phylotree.trigger_refresh(phylotree);
        }

        function menuItem(dataName){
          // Annotations: 0 state, 1 name, 2 fullname, 3 family, 4 ligand type, 5 class, 6 method, 7 ligand function
          switch(dataName){
              case "No data":
                return -1;
              case "Receptor activation state":
                return 0;
              case "GPCR class":
                return 5
              case "Ligand type":
                return 4
              case "Receptor family":
                return 3
              case "Experimental method":
                return 6
              case "All G-protein coupling":
                return 8
              case "Primary G-protein coupling":
                return 9
              case "Secondary G-protein coupling":
                return 10
              case "Ligand function":
                return 7
              default:
                return -1
          }
        }

        function connectedPDBs(node){
          var descendants = []
          phylotree.descendants(node).forEach(function(leafnode) {
            descendants.push(leafnode.name);
          });
          return descendants;
        }

        function inGroup1(node) {
          var selected = connectedPDBs(node);
          let intersection = selected.filter(x => group1.includes(x));

          return intersection.length > 0;
        }

        function notInGroup1(node) {
          var selected = connectedPDBs(node);
          let distinct = selected.filter(x => !group1.includes(x));

          return distinct.length > 0;
        }

        function inGroup2(node) {
          var selected = connectedPDBs(node);
          let intersection = selected.filter(x => group2.includes(x));

          return intersection.length > 0;
        }

        function notInGroup2(node) {
          var selected = connectedPDBs(node);
          let distinct = selected.filter(x => !group2.includes(x));

          return distinct.length > 0;
        }

        function removeGroup(selector, node) {
          // Go through nodes and update selection
          function sel(d) {
              if (d3.layout.phylotree.is_leafnode(d)) {
                if (selector > 0)
                  group2 = remove(group2, d.name)
                else
                  group1 = remove(group1, d.name)
              }

              d['group' + selector ] = false
              if (d.children && d.children.length > 0){
                d.children.forEach(sel);
              }
          }
          sel(node);

          // unique PDB codes
          group1 = Array.from(new Set(group1))
          group2 = Array.from(new Set(group2))
          group1.sort()
          group2.sort()

          // Toggle buttons
          if (group1.length == 0 && group2.length == 0){
            $("#CN-button").addClass("disabled");
            $("#DN-button").addClass("disabled");
          }

          // update selection with PDB codes
          var textarea = document.getElementById('input-targets-'+selector);
          if (selector > 0)
            textarea.value = group2.join("\n");
          else
            textarea.value = group1.join("\n");

          // refresh layout with updated selections
          d3.layout.phylotree.trigger_refresh(phylotree);
        }

        function remove(array, element) {
          return array.filter(el => el !== element);
        }

        function nodeStyler(element, node){
            if (d3.layout.phylotree.is_leafnode(node)) {
                if (node.name in treeAnnotations) {
                    var node_label = element.select("text");
                    var font_size  = parseFloat(node_label.style("font-size"));
                    var scale = 0.8;

                    // Add inner markers
                    element.selectAll("circle").remove()
                    var firstColor = "#CCC";
                    if (displayDataInner >= 0) {
                      if (!Array.isArray(treeAnnotations[node.name][displayDataInner]))
                        treeAnnotations[node.name][displayDataInner] = [treeAnnotations[node.name][displayDataInner]]

                      for (var i = 0; i < treeAnnotations[node.name][displayDataInner].length; i++) {
                        var currentType = typeClasses[displayDataInner]
                        var currentData = treeAnnotations[node.name][displayDataInner][i]
                        var classIndex = dataClasses[displayDataInner].indexOf(currentData)
                        var currentColor = colorClasses[displayDataInner][classIndex]
                        if (i==0){
                          firstColor = currentColor
                        }

                        var annotation = element.append("circle")
                        annotation.attr("r", (font_size*scale)/2)
                          .style("stroke", "#000")
                          .style("stroke-width", font_size/20+"px")
                          .style("fill", currentColor)
                          .on("mouseover", function(d) { // add tooltip
                              class_tooltip.transition()
                                .style("opacity", .9);
                              class_tooltip.html("<b>" + typeClasses[displayDataInner] + ":</b> " + $(d3.event.target).data("datalabel"))
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                            })
                          .on("mouseout", function() {
                              class_tooltip.transition().duration(100)
                                  .style("opacity", 0);
                          });

                          annotation.attr("data-datalabel", currentData)

                        // Shift circles according to placement label
                        if (phylotree.radial ()) {
                            var shifter_rect = phylotree.shift_tip(node)[0];
                            var setX = shifter_rect > 0 ? shifter_rect -  font_size*scale/1.8  - i*(font_size*scale): shifter_rect + font_size*scale/1.8 + i*(font_size*scale);
                            annotation.attr("transform", "rotate (" + node.text_angle + ")")
                                .attr ("cx", setX)
                        }
                      }

                      // Color branch-tracer
                      var tracer = element.select("line")[0][0];
                      tracer.setAttribute("stroke-dasharray", "3,4");
                      tracer.setAttribute("stroke-width", Math.min(1.5, font_size/3*2));
                      tracer.className.baseVal = ""
                      if (doBranchColoring) {
                        // check length of current and if array
                        if (treeAnnotations[node.name][displayDataInner].length > 1 && 'colorClasses' in node && Array.isArray(node['colorClasses'][displayDataInner]) && node['colorClasses'][displayDataInner].length >= 1) {
                          classIndex = dataClasses[displayDataInner].indexOf(node['colorClasses'][displayDataInner][0])
                          firstColor = colorClasses[displayDataInner][classIndex]
                        }

                        tracer.setAttribute("stroke", firstColor);
                      } else {
                        tracer.setAttribute("stroke", "#CCC");
                      }
                    }

                    var labelName
                    if (displayName == 1) {
                      // fix italics and subscript annotations
                      labelName = treeAnnotations[node.name][2].replace(new RegExp(" receptor$"), "")
                      labelName = labelName.replace("-adrenoceptor", '')
                      labelName = labelName.replace(" receptor-", '-')

                      labelName = labelName.replace("<sub>", '<tspan baseline-shift = "sub">')
                      labelName = labelName.replace("</sub>", '</tspan>')
                      labelName = labelName.replace("<i>", '<tspan font-style = "italic">')
                      labelName = labelName.replace("</i>", '</tspan>')
                    } else
                      labelName = treeAnnotations[node.name][1].split("_")[0].toUpperCase()

                    label = node_label[0][0]
                    // Space left and right of the label (instead of &nbsp/&#160 which breaks SVG)
                    label.setAttribute("margin-left", font_size+"px")
                    label.setAttribute("margin-right", font_size+"px")

                    if (hidePDBs){
                      label.innerHTML = labelName
                    } else {
                      label.innerHTML = labelName + " (" + node.name + ")"
                      // Extra: rotate labels when on the left half
                      if (!labelReorder && label.getAttribute("dx") != null && label.getAttribute("dx") < 0)
                        label.innerHTML = "(" + node.name + ") " + labelName
                    }

                    // color labels
                    if ( 'group0' in node && node['group0'] && 'group1' in node && node['group1'])
                      element.style("fill", "purple");
                    else if ('group0' in node && node['group0'])
                      element.style("fill", "red");
                    else if ('group1' in node && node['group1'])
                      element.style("fill", "blue");
                    else {
                      if (doBranchColoring)
                        element.style("fill", firstColor);
                      else
                        element.style("fill", "black");
                    }

                    // Add outer markers
                    element.selectAll("rect").remove() // remove old data
                    if (displayData >= 0){

                      if (!Array.isArray(treeAnnotations[node.name][displayData]))
                        treeAnnotations[node.name][displayData] = [treeAnnotations[node.name][displayData]]

                      for (var i = 0; i < treeAnnotations[node.name][displayData].length; i++) {
                        var currentType = typeClasses[displayData]
                        var currentData = treeAnnotations[node.name][displayData][i]
                        var classIndex = dataClasses[displayData].indexOf(currentData)
                        var currentColor = colorClasses[displayData][classIndex]

                        // create block
                        var annotation = element.append("rect")
                        annotation.attr("width", font_size*scale*0.9)
                          .style("stroke", "#000")
                          .style("stroke-width", font_size/20+"px")
                          .attr("height", font_size*scale*0.9)
                          .attr ("y", -(font_size*scale)/2)
                          .attr("fill", currentColor)
                          .on("mouseover", function(d) { // add tooltip
                              class_tooltip.transition()
                                .style("opacity", .9);
                              class_tooltip.html("<b>" + currentType + ":</b> " + $(d3.event.target).data("datalabel"))
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                            })
                          .on("mouseout", function() {
                              class_tooltip.transition().duration(100)
                                  .style("opacity", 0);
                          });

                          // label
                          var toollabel = ""
                          annotation.attr("data-datalabel", currentData)

                        if (phylotree.radial ()) {
                            var shifter_rect = phylotree.shift_tip(node)[0];
                            var setX = shifter_rect > 0 ? shifter_rect + maxLeafNodeLenght + i*(font_size*scale+2) : shifter_rect - maxLeafNodeLenght - font_size*scale*0.9 - i*(font_size*scale+2);
                            annotation.attr("transform", "rotate (" + node.text_angle + ")")
                                .attr ("x", setX)
                        } else {
                            var x_shift_rect = phylotree.shift_tip(node)[0] + maxLeafNodeLenght + i*(font_size*scale+2);
                            annotation.attr("transform", null).attr("x", function (d, i) { return  x_shift_rect + font_size * i;})
                        }
                      }
                    }
                } else {
                  console.log("Structure without annotation: " + node.name)
                }
            } else {
                // restyle innner node by coloring according to silhouette score
                silhouette_color = "#FFFFFF";
                if (!isNaN(node.name)) {
                  var score = node.name;
                  if (score>1) score=1;

                  if (score>0){
                    silhouette_color = shadeColor2("#AAAAAA", 100-(score*80-20));
                  } else {
                    silhouette_color = "#FFAAAA";
                  }

                }
                element.selectAll("circle").style("fill", silhouette_color)

                // Add tooltip
                element.selectAll("circle").on("mouseover", function(d) { // add tooltip
                    class_tooltip.transition()
                      .style("opacity", .9);
                    class_tooltip.html("<b>Silhouette score:</b> " + score)
                      .style("left", (d3.event.pageX) + "px")
                      .style("top", (d3.event.pageY - 28) + "px");
                  })
                .on("mouseout", function() {
                    class_tooltip.transition().duration(100)
                        .style("opacity", 0);
                });
            }
        }

        function branchStyler(element, node){
            if ( 'group0' in node.target && node.target['group0'] && 'group1' in node.target && node.target['group1']) {
              element.style("stroke", "purple");
              element.style("stroke-width", 3)
            } else if ('group0' in node.target && node.target['group0']) {
              element.style("stroke", "red");
              element.style("stroke-width", 3)
            } else if ('group1' in node.target && node.target['group1']) {
              element.style("stroke", "blue");
              element.style("stroke-width", 3)
            } else {
              element.style("stroke-width", 1.5)
              element.style("stroke", "#CCC");
              if (doBranchColoring && displayDataInner >= 0 && 'colorClasses' in node.target){
                // color according to shared feature
                if (node.target['colorClasses'][displayDataInner] != "-" && node.target['colorClasses'][displayDataInner].length > 0 ) {
                    if (Array.isArray(node.target['colorClasses'][displayDataInner])) {
                      // if array with multiple options - first based on previous connection
                      if (node.target['colorClasses'][displayDataInner].length > 1){
                          if (node.source['colorClasses'][displayDataInner] != "-" && node.source['colorClasses'][displayDataInner].length > 0){
                            node.target['colorClasses'][displayDataInner] = node.target['colorClasses'][displayDataInner].filter(x => node.source['colorClasses'][displayDataInner].includes(x))
                          }
                      }
                      var select = dataClasses[displayDataInner].indexOf(node.target['colorClasses'][displayDataInner][0])
                      element.style("stroke", colorClasses[displayDataInner][select]);
                    } else {
                      var select = dataClasses[displayDataInner].indexOf(node.target['colorClasses'][displayDataInner])
                      element.style("stroke", colorClasses[displayDataInner][select]);
                    }
                }
              }
            }
        }

        // Based on https://stackoverflow.com/questions/5560248
        function shadeColor2(color, percent) {
            var R = parseInt(color.substring(1,3),16);
            var G = parseInt(color.substring(3,5),16);
            var B = parseInt(color.substring(5,7),16);

            R = parseInt(R * percent/100);
            G = parseInt(G * percent/100);
            B = parseInt(B * percent/100);
            R = (R<255)?R:255;
            G = (G<255)?G:255;
            B = (B<255)?B:255;

            var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }

        function downloadNewick(name){
          // Obtain from download data
          if ("tree" in treedata){
            download(name, treedata["tree"])
          }
        }

        function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
          element.setAttribute('download', filename);

          element.style.display = 'none';
          document.body.appendChild(element);
          element.click();

          document.body.removeChild(element);
        }

        function downloadSVG(svgSelector, name) {
          if ($("#" + svgSelector).length > 0) {
            var ContainerElements = ["svg","g"];
            var RelevantStyles = {"rect":["fill","stroke","stroke-width"],"path":["fill","stroke","stroke-width"],"circle":["fill","stroke","stroke-width"],"line":["stroke","stroke-width"],"text":["fill","font-size","text-anchor"],"polygon":["stroke","fill"]};
            function read_Element(ParentNode, OrigData){
                var Children = ParentNode.childNodes;
                var OrigChildDat = OrigData.childNodes;

                for (var cd = 0; cd < Children.length; cd++){
                    var Child = Children[cd];

                    var TagName = Child.tagName;
                    if (ContainerElements.indexOf(TagName) != -1){
                        read_Element(Child, OrigChildDat[cd])
                    } else if (TagName in RelevantStyles){
                        var StyleDef = window.getComputedStyle(OrigChildDat[cd]);

                        var StyleString = "";
                        for (var st = 0; st < RelevantStyles[TagName].length; st++){
                            StyleString += RelevantStyles[TagName][st] + ":" + StyleDef.getPropertyValue(RelevantStyles[TagName][st]) + "; ";
                        }

                        Child.setAttribute("style",StyleString);
                    }
                }
            }

            var SVGElem = document.getElementById(svgSelector);
            var oDOM = SVGElem.cloneNode(true);
            read_Element(oDOM, SVGElem)

            var escapedSVG = new XMLSerializer().serializeToString(oDOM);
            var svg = new Blob([escapedSVG], { type: "image/svg+xml;charset=utf-8" });
            var url = URL.createObjectURL(svg);

            downloadURI(url, name);
          }
        }

        function downloadPNG(pngSelector, name) {
          var SVGElem = document.getElementById(pngSelector);
          var oDOM = SVGElem.cloneNode(true);

          // Key: strip xmlns tags otherwise this will result in a double definition
          oDOM.removeAttribute("xmlns");

          // Note: keep scale low enough for Chrome to allow download (max size 1.3MB)
          saveSvgAsPng(oDOM, name, {scale: 2});
        }

        var lastData;
        var newCluster = false;
        function initializeButtons(selector, treeFunction) {
            $(selector + ' .go-button').click(function() {
                var pdbs = JSON.parse($(selector + ' .crystal-pdb').val());

                // DEBUG input:
                if (pdbs.length == 0)
                  pdbs = ["6A94", "6IIV", "6FJ3", "3V2Y", "5T04", "6BQH", "5DSG", "6E3Y", "4Z35", "6B73", "3RZE", "4ZUD", "4XT1", "5ZTY", "5WIV", "3VW7", "5YWY", "4Z9G", "4XNW", "5ZBH", "5TUD", "5VEW", "5UEN", "6AK3", "4BUO", "5X33", "5DHG", "5CXV", "6D32", "5NX2", "4ZJ8", "4MQT", "4DJH", "5TGZ", "6BD4", "5XSZ", "5ZKP", "4OR2", "5ZKQ", "5ZKC", "6HLL", "3OE9", "6MXT", "6C1R", "5WQC", "6D26", "5XRA", "4PY0", "5OM1", "5NJ6", "5XF1", "5UNF", "6N51", "5CGC", "6IGK", "5TZR", "2YCZ", "6DDF", "2YDV", "4XEE", "4IAR", "5X7D", "5EN0", "5XPR", "4U15", "6DO1", "6AKY", "6GPS", "5UZ7", "4RWD", "5G53", "6BQG", "2G87", "6D9H", "6G79", "6CM4", "6B3J", "4DKL", "6DS0", "5VBL", "6H7O", "6M9T", "3PBL"]

                if (pdbs.length > 1) {
                    $("#clustering-tree").html("")
                    $("#svgloading").remove();
                    $(selector + ' .tree-container').append('<span id="svgloading">Loading...</span>');
                    newCluster = (this.innerHTML=="Go (distance to core)")
                    $.getJSON( '/contactnetwork/clusteringdata',
                    {
                        'pdbs': pdbs.join(","),
                        'new_cluster': newCluster
                    },
                    /*$.post('/contactnetwork/clusteringdata',
                    {
                        'pdbs': pdbs,
                    },*/
                    function( data ) {
                        lastData = data

                        // create Tee
                        treeFunction(data);

                        // reset all elements
                        $("#svgloading").remove();
                        $("#output-group0").removeClass("hidden");
                        $("#input-targets-0").val("");
                        $("#output-group1").removeClass("hidden");
                        $("#input-targets-1").val("");
                        $("#submit-group").removeClass("hidden");
                        $("#CN-button").addClass("disabled");
                        $("#DN-button").addClass("disabled");
                        firstTreeClick = true;

                        // zoom + pan - internal zoom of phylotree is buggy
                        var container = "#clustering-tree";

                        // Destroy old zoom on update
                        if (window.zoomCluster[container] != null) {
                          window.zoomCluster[container].destroy();
                          delete window.zoomCluster[container];
                        }

                        //
                        window.zoomCluster[container] = svgPanZoom(container, {
                            zoomEnabled: true,
                            // controlIconsEnabled: true,
                            fit: false,
                            center: false,
                            minZoom: 0.1,
                            maxZoom: 10,
                            zoomScaleSensitivity: 0.25,
                            dblClickZoomEnabled: true
                        });

                        // Calculate zoom level as center + fit doesn't work correctly
                        window.zoomCluster[container].zoom(1.5);
                        // Manual center
                        window.zoomCluster[container].center()

                    });
                } else {
                    toggleAlert()
                }
            });

            $(selector + ' #CN-button').click(function(){ if (!$(this).hasClass("disabled")) { submitToPage("CN"); }});
            $(selector + ' #DN-button').click(function(){ if (!$(this).hasClass("disabled")) { submitToPage("DN") }});
        }

        function submitToPage(destination){
          var url = "/contactnetwork/interactions";
          if (destination=="DN")
              url = "/contactnetwork/distances";

          var form = $('<form action="' + url + '" method="post">' +
              '<textarea name="pdbs1" id="submit-pdbs1" />' +
              '<textarea name="pdbs2" id="submit-pdbs2" />' +
              "{% csrf_token %}" +
              '</form>');
          $('body').append(form);

          // set values
          $("#submit-pdbs1").val($("#input-targets-0").val());
          $("#submit-pdbs2").val($("#input-targets-1").val());
          form.submit();
        }

        function toggleAlert(){
            $(".alert_pdb").fadeTo(2000, 500).slideUp(500, function(){
                $("#success-alert").slideUp(500);
            });
            return false;
        }

        function initializeTopButtons(selector) {
            // Fullscreen SVG
            $(selector + ' .btn-fullscreen').click(function() {
                fullScreenElement = $(this).parent().next().children().first();
                fullScreenElement.css('background-color','white');
                toggleFullScreen(fullScreenElement.get(0));
            });

            // Dendrogram download in SVG
            $(selector + ' .btn-download-alt').click(function() {
                // svg download
                downloadSVG("clustering-tree", "GPCR_structure_clustering.svg")
            });

            // Dendrogram download in newick
            $(selector + ' .btn-newick').click(function() {
                // svg download
                downloadNewick("GPCR_structure_clustering.tree")
            });

            // Dendrogram download in PNG
            $(selector + ' .btn-camera').click(function() {
                // svg download
                downloadPNG("clustering-tree", "GPCR_structure_clustering.png")
            });

            // Distance matrix download
            $(selector + ' .btn-download').click(function() {
                // create download table
                if (lastData != undefined){
                    var header = lastData['dm_labels']
                    header.unshift("PDB-code")

                    var data = [];
                    data.push(header);

                    for (var i = 0; i < lastData["distance_matrix"].length ; i++){
                      var row = lastData["distance_matrix"][i]
                      row.unshift(header[i+1])
                      data.push(row);
                    }

                    // Convert to CSV
                    var csv = Papa.unparse(data);

                    // Download file
                    downloadURI('data:text/csv;charset=UTF-8,' + encodeURI(csv), "GPCR_structure_clustering.csv");
                }
            });
        }

        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }

        function toggleFullScreen(fullScreenElement) {
            if (!document.mozFullScreen && !document.webkitFullScreen) {
                if (fullScreenElement.mozRequestFullScreen) {
                    fullScreenElement.mozRequestFullScreen();
                } else {
                    fullScreenElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
                }
            } else {
                if (document.mozCancelFullScreen) {
                  document.mozCancelFullScreen();
                } else {
                  document.webkitCancelFullScreen();
                }
            }
        }

        $('#single-crystal-group-pdbs-modal-table').on('shown.bs.modal', function (e) {
          showPDBtable('#single-crystal-group-pdbs-modal-table');
        })

        $(document).ready(function() {
            // Get PDBs for table build
            $.get('pdbtabledata', function ( data ) {
              $('#single-crystal-group-pdbs-modal-table .tableview').html(data);
              pdbtabledata = data;
            });

            // Single group of PDB files
            initializeButtons('#single-crystal-group-tab', renderTree);
            initializeTopButtons('#single-crystal-group-tab');

            // init tree toggles
            // Button Toggles
            $("#radial-layout").on("click", function(e) {
              var radial = $(this).prop("checked");
              phylotree.radial(radial).placenodes().update();
              if (!radial){
                $("#clustering-tree g.svg-pan-zoom_viewport").css("transform", "matrix(.8, 0, 0, .8, 0, 0)")
              } else {
                window.zoomCluster["#clustering-tree"].zoom(1.1)
                window.zoomCluster["#clustering-tree"].center()
              }
            });

            $("#colored-edges").on("click", function(e) {
              doBranchColoring = $("#colored-edges").prop("checked")
              // Refresh twice to ensure correct leaf coloring
              d3.layout.phylotree.trigger_refresh(phylotree);
              d3.layout.phylotree.trigger_refresh(phylotree);
            });

            $("#hide-pdbs").on("click", function(e) {
              // refresh layout
              hidePDBs = $("#hide-pdbs").prop("checked")
              d3.layout.phylotree.trigger_refresh(phylotree);
              maximumLeafSize();
            });

            $("#label-order").on("click", function(e) {
              // refresh layout
              labelReorder = $("#label-order").prop("checked")
              d3.layout.phylotree.trigger_refresh(phylotree);
            });

            // init dropdowns
            $(".dropdown-menu.names").on("click", "li", toggleNames)
            $(".dropdown-menu.dataouter").on("click", "li", toggleDataOuter)
            $(".dropdown-menu.datainner").on("click", "li", toggleDataInner)
        });

        var class_tooltip = d3.select("body").append("div")
                              .attr("class", "class_tooltip")
                              .style("opacity", 0);
    </script>
{% endblock %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/phylo.css' %}" type="text/css" />

    <style type="text/css">
        /* START TREE */
        /*
        .node circle {
          fill: #fff;
          stroke: black;
          stroke-width: 0.5px;
          cursor: pointer;
        }

        .node circle.group0 {
          fill: #FF0000!important;
          stroke: black;
        }

        .node circle.group1 {
          fill: #0000FF!important;
          stroke: black;
        }

        .node, text {
          font: 13px sans-serif;
        }

        .link {
          fill: none;
          stroke: #ccc;
          stroke-width: 3.5px;
        }

        .link.selected {
          fill: none;
          stroke: #888;
          stroke-width: 5px;
        }

        .link.group0 {
          fill: none;
          stroke: #ff7c7c;
          stroke-width: 3.5px;
        }

        .link.group0.selected {
            stroke-width: 5px;
            stroke: #db6d6d;
        }
        .link.group1 {
          fill: none;
          stroke: #82b1ff;
          stroke-width: 3.5px;
        }

        .link.group1.selected {
            stroke-width: 5px;
            stroke: #6d97db;
        }

        circle {
          fill : #100;
        }


        text {
          fill: #000;
        }
        */
        /* END TREE */



        textarea#input-targets-0 {
          background-color: rgba(255, 124, 124, 0.1);
        }

        textarea#input-targets-1 {
            background-color: rgba(124, 124, 255, 0.1);
        }

        .btn-download, .btn-download-alt, .btn-fullscreen, .btn-camera, .btn-newick {
          margin-right: 10px;
        }

        .select2-result-label{
            font-size:x-small;
            font-size: 10px;
        }

        .no-top-border{
            border-top: 0px;
        }

        #filters{
            float:left;
          display:none;
          position:absolute;
          background:white;
          border: 1px solid #D1C9C2;
          border-top: 1;
          width: 400px;
          margin: 0 auto;
          padding:  7px 15px;
          text-align: left;
          -webkit-border-bottom-right-radius: 6px;
          -webkit-border-bottom-left-radius: 6px;
          -moz-border-radius-bottomright: 6px;
          -moz-border-radius-bottomleft: 6px;
          border-bottom-right-radius: 6px;
          border-bottom-left-radius: 6px;
          z-index: 1;
            font-size: 10px;
        }

        @media (min-width: 1800px){
            #content {
                width: 1770px;
            }
        }

        @media (min-width: 2200px){
            #content {
                width: 100%;
                padding-left: 100px;
                padding-right: 100px;
            }
        }

        @media (min-width: 1200px) {
          .modal-wide {
            width: 1200px;
          }
        }
        @media (min-width: 1800px) {
          .modal-wide {
            width: 1800px;
          }
        }
        @media (min-width: 2400px) {
          .modal-wide {
            width: 2400px;
          }
        }

        .modal-footer {
            border-top: 0px;
        }

        @media screen and (max-width: 992px) {
            .go-button {
                width: 100%;
                margin-bottom: 15px;
            }
        }

        .highlighted {
            stroke: #286090 !important;
            stroke-width: 3 !important;
            opacity: 1 !important;
        }
        .svg-download-button {
            margin-top: 6px;
        }

        div.class_tooltip {
            padding: 4px;
        }

        div.tooltip {
          padding: 5px;
          border-radius: 10px;
          font-size: 1em;
          background-color: #FFF;
          border: 1px solid black;
        }
    </style>



{% endblock %}
